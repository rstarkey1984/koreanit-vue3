# 14. JWT 기반 인증(Authentication)

## 학습 목표

* 인증(Authentication)과 인가(Authorization)의 차이를 설명할 수 있다
* 로그인 → 토큰 발급 → 보호 API 접근 흐름을 이해한다
* Authorization 헤더(Bearer)를 이용해 JWT를 전달할 수 있다
* Express 인증 미들웨어로 보호 API를 만들 수 있다
* 실패 케이스(토큰 없음/만료/위조)를 401로 처리할 수 있다

---

## 1. 왜 인증이 필요한가

지금까지 만든 API는 기능은 잘 동작하지만, 문제는 이것이다.

* 누구나 `POST /api/news`, `DELETE /api/news` 같은 요청을 보낼 수 있다
* 서버는 “이 요청이 누가 보낸 건지” 모른다

API 서버는 기본적으로 **Stateless(무상태)** 이다.

* 서버는 “방금 로그인한 사람”을 기억하지 않는다
* 매 요청마다 “너 누구냐”를 증명해야 한다

그래서 등장하는 방식이 **토큰 기반 인증**이다.

---

## 2. 인증과 인가의 차이

* 인증(Authentication)

  * “너 누구냐?”
  * 로그인, 토큰 검증
* 인가(Authorization)

  * “너 이거 해도 되냐?”
  * 관리자만 삭제 가능, 본인 글만 수정 가능 등

이번 장(14.md)은 **인증(Authentication)** 까지만 다룬다.

---

## 3. JWT란 무엇인가

JWT(JSON Web Token)는

* 서버가 로그인 성공 시 토큰을 발급하고
* 클라이언트가 이후 요청에 토큰을 실어 보내고
* 서버는 토큰이 유효한지만 검사하는 방식

특징

* 서버가 세션을 저장하지 않아도 된다 (Stateless에 잘 맞음)
* 토큰이 위조되지 않았는지만 검증한다 (서명 기반)

중요 포인트

* JWT는 “암호화”가 아니라 “서명(Signature)”이다
* 누가 만들었는지(서버가 만든 것인지) 검증하는 구조다

---

## 4. 이번 실습에서 만들 것

### 4-1. API 구성

* `POST /api/auth/login`

  * 아이디/비밀번호 확인
  * 성공 시 JWT 발급
* `GET /api/auth/me`

  * 토큰이 있으면 사용자 정보 응답 (보호 API)

### 4-2. 로그인 계정

DB를 붙이기 전 단계이므로, 로그인 계정은 코드에 박아둔다.

예)

* id: `admin`
* pw: `1234`

---

## 5. 패키지 설치

```bash
npm i jsonwebtoken
```

---

## 6. 환경변수 설정 (.env)

프로젝트 루트 `.env`

```env
PORT=3000
NODE_ENV=development
JWT_SECRET=dev-secret-key
JWT_EXPIRES_IN=1h
```

주의

* JWT_SECRET은 토큰 서명에 쓰는 키다
* 실서비스에서는 절대 코드에 박아두면 안 된다

---

## 7. 로그인 계정 상수 만들기

`app/config/auth.js`

```js
const AUTH_USER = {
  id: "admin",
  password: "1234",
  name: "관리자"
};

module.exports = { AUTH_USER };
```

---

## 8. 로그인 컨트롤러 만들기

`app/controllers/auth.controller.js`

```js
const jwt = require("jsonwebtoken");
const { ok, fail } = require("../utils/response");
const { AUTH_USER } = require("../config/auth");

function loginController(req, res) {
  const { id, password } = req.body;

  // 입력값 검증(최소)
  if (!id || !password) {
    return fail(res, "id/password가 필요합니다", 400);
  }

  // 하드코딩 계정 확인
  if (id !== AUTH_USER.id || password !== AUTH_USER.password) {
    return fail(res, "아이디 또는 비밀번호가 올바르지 않습니다", 401);
  }

  const payload = {
    id: AUTH_USER.id,
    name: AUTH_USER.name
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: process.env.JWT_EXPIRES_IN || "1h"
  });

  // 토큰 응답은 캐시 금지 권장
  res.set("Cache-Control", "no-store");

  return ok(res, { token }, "로그인 성공", 200);
}

function meController(req, res) {
  // auth 미들웨어가 req.user를 세팅해준다는 가정
  return ok(res, { user: req.user }, "내 정보", 200);
}

module.exports = { loginController, meController };
```

---

## 9. 인증 미들웨어 만들기 (Bearer 토큰 검증)

`app/middlewares/authRequired.js`

```js
const jwt = require("jsonwebtoken");
const { fail } = require("../utils/response");

function authRequired(req, res, next) {
  const auth = req.headers.authorization;

  // Authorization: Bearer <token>
  if (!auth || !auth.startsWith("Bearer ")) {
    return fail(res, "인증 토큰이 필요합니다", 401);
  }

  const token = auth.slice("Bearer ".length);

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded; // 이후 컨트롤러에서 사용
    return next();
  } catch (err) {
    return fail(res, "토큰이 유효하지 않습니다", 401, err.message);
  }
}

module.exports = authRequired;
```

포인트

* 토큰이 없으면 401
* 토큰이 위조/만료면 401
* 성공하면 `req.user`를 만들어 다음으로 넘긴다

---

## 10. 라우터 만들기

`app/routes/auth.router.js`

```js
const express = require("express");
const router = express.Router();

const authCtl = require("../controllers/auth.controller");
const authRequired = require("../middlewares/authRequired");

router.post("/login", authCtl.loginController);
router.get("/me", authRequired, authCtl.meController);

module.exports = router;
```

---

## 11. app.js에 라우터 등록

`app/app.js`에서 라우터 등록 추가

```js
const authRouter = require("./routes/auth.router");

app.use("/api/auth", authRouter);
```

---

## 12. 호출 테스트

### 12-1. 로그인

```bash
### api/auth/login
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{"id":"admin","password":"1234"}
```

응답에서 token을 복사한다.

### 12-2. 보호 API 호출

```bash
curl http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer 토큰값"
```

---

## 13. 핵심 요약

* JWT 인증은 “로그인 후 토큰 발급 → 이후 요청에 토큰 포함” 흐름이다
* 토큰 전달은 `Authorization: Bearer <token>` 헤더를 사용한다
* 인증 미들웨어는 토큰을 검증하고 `req.user`를 만들어준다
* 토큰이 없거나 유효하지 않으면 401로 차단한다
* 지금은 DB 없이 학습용으로 계정을 코드에 하드코딩한다

# Express API 서버 미들웨어 + 공통응답 적용

## 학습 목표

* 미들웨어가 무엇이고 어디에 두는지 이해한다
* 응답 JSON 포맷을 통일할 수 있다
* 컨트롤러의 에러를 한 곳(에러 미들웨어)에서 처리할 수 있다

---

## 1. 오늘 추가할 것

구조화(app / router / controller)에 이어서 서버 품질을 올리는 공통 처리 4가지를 추가한다.

1. 요청 로그 미들웨어
2. 공통 응답 함수(ok / fail)
3. 공통 에러 처리 미들웨어(error handler)
4. 404 공통 처리 미들웨어(notFound)

---

## 2. 최종 폴더 구조

```text
app/
├─ index.js
├─ app.js
├─ routes/
│  └─ news.router.js
├─ controllers/
│  └─ news.controller.js
├─ middlewares/
│  ├─ requestLogger.js
│  ├─ notFound.js
│  └─ errorHandler.js
└─ utils/
   └─ response.js
```

추가 폴더 / 파일 생성 명령어:

```bash
mkdir -p app/middlewares app/utils \
  && touch app/middlewares/requestLogger.js app/middlewares/errorHandler.js app/middlewares/notFound.js \
  && touch app/utils/response.js
```

---

## 3. 미들웨어란 무엇인가

미들웨어는 **요청(Request)과 응답(Response) 사이에서 실행되는 공통 함수**다.

요청 처리 흐름:

```
요청 → 미들웨어들 → 라우터 → 컨트롤러 → 응답
```

미들웨어가 담당하는 대표 기능

* 로그 기록
* 입력값 검증
* 인증 / 권한 처리
* 에러 처리

---

## 4. 요청 로그 미들웨어 만들기

`app/middlewares/requestLogger.js`

```js
function requestLogger(req, res, next) {
  const start = Date.now();

  res.on("finish", () => {
    const ms = Date.now() - start;
    console.log(`[LOG] ${req.method} ${req.originalUrl} ${res.statusCode} ${ms}ms`);
  });

  next();
}

module.exports = requestLogger;
```

포인트

* `next()`를 호출해야 다음 단계로 진행된다
* `res.on("finish")`는 응답이 끝난 뒤 실행되어 상태 코드까지 기록할 수 있다

---

## 5. 404 공통 처리 미들웨어 (notFound)

존재하지 않는 URL로 요청이 들어왔을 때도 응답 형식을 통일하기 위해 404 전용 미들웨어를 추가한다.

404 미들웨어는 **모든 라우터 뒤**, **에러 처리 미들웨어 앞**에 둔다.

### 5-1. 404 미들웨어 만들기

`app/middlewares/notFound.js`

```js
const { fail } = require("../utils/response");

function notFound(req, res, next) {
  return fail(res, "존재하지 않는 API입니다", 404);
}

module.exports = notFound;
```

### 5-2. 404 동작 확인

요청

```
GET /api/unknown
```

응답

```js
{
  success: false,
  code: 404,
  message: "존재하지 않는 API입니다",
  error: null
}
```

---

## 6. 공통 응답 함수 만들기

`app/utils/response.js`

```js
function ok(res, data = null, message = "OK", code = 200) {
  return res.status(code).json({
    success: true,
    code,
    message,
    data,
  });
}

function fail(res, message = "FAIL", code = 500, error = null) {
  return res.status(code).json({
    success: false,
    code,
    message,
    error,
  });
}

module.exports = { ok, fail };
```

규칙

* 성공 / 실패와 관계없이 응답 구조를 고정한다
* 프론트엔드는 `success`, `message`, `data`만 기준으로 처리할 수 있다

---

## 7. 공통 에러 처리 미들웨어 만들기

이 미들웨어는 서버에서 발생한 모든 에러를 **한 곳에서 처리**하기 위한 전용 미들웨어다.

컨트롤러나 다른 미들웨어에서 에러가 발생하면 `next(err)`로 전달한다.

에러 처리 미들웨어는 다음 형태를 가진다.

```js
function errorHandler(err, req, res, next) {
  ...
}
```

첫 번째 인자가 `err`인 함수는 Express가 **에러 전용 미들웨어**로 인식한다.

`app/middlewares/errorHandler.js`

```js
const { fail } = require("../utils/response");

function errorHandler(err, req, res, next) {
  console.error("[ERROR]", err);

  if (res.headersSent) return next(err);

  return fail(res, "서버 오류", 500, err.message);
}

module.exports = errorHandler;
```

---

## 8. app.js에 미들웨어 장착하기

`app/app.js`

```js
const express = require("express");
const app = express();

const newsRouter = require("./routes/news.router");
const requestLogger = require("./middlewares/requestLogger");
const notFound = require("./middlewares/notFound");
const errorHandler = require("./middlewares/errorHandler");

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

app.use(requestLogger);

app.get("/", (req, res) => {
  res.send("API 서버 실행 중");
});

app.use("/api/news", newsRouter);

app
  .route("/api/dev/:path")
  .get((req, res) => res.json(makeRequestInfo(req)))
  .post((req, res) => res.json(makeRequestInfo(req)))
  .put((req, res) => res.json(makeRequestInfo(req)))
  .delete((req, res) => res.json(makeRequestInfo(req)));

function makeRequestInfo(req) {
  return {
    method: req.method,
    url: req.originalUrl,
    params: req.params,
    query: req.query,
    body: req.body,
  };
}

app.use(notFound);
app.use(errorHandler);

module.exports = app;
```

중요 순서

* 로그 미들웨어 → 라우터 → 404 미들웨어 → 에러 미들웨어

---

## 9. news 컨트롤러에 공통 응답 적용

`app/controllers/news.controller.js`

```js
const fs = require("fs").promises;
const path = require("path");
const { ok } = require("../utils/response");

const DATA_PATH = path.join(__dirname, "..", "..", "data", "news.json");

async function newsListController(req, res, next) {
  try {
    const raw = await fs.readFile(DATA_PATH, "utf-8");
    const data = JSON.parse(raw);
    return ok(res, data, "뉴스 목록", 200);
  } catch (err) {
    return next(err);
  }
}

function newsPostController(req, res) {
  return ok(res, { body: req.body }, "NEWS POST", 200);
}

function newsPutController(req, res) {
  return ok(res, { body: req.body }, "NEWS PUT", 200);
}

function newsDeleteController(req, res) {
  return ok(res, null, "NEWS DELETE", 200);
}

module.exports = {
  newsListController,
  newsPostController,
  newsPutController,
  newsDeleteController,
};
```

---

## 10. 라우터는 연결만 담당

`app/routes/news.router.js`

```js
const express = require("express");
const router = express.Router();

const newsCtl = require("../controllers/news.controller");

router
  .route("/")
  .get(newsCtl.newsListController)
  .post(newsCtl.newsPostController)
  .put(newsCtl.newsPutController)
  .delete(newsCtl.newsDeleteController);

module.exports = router;
```

---

## 11. 실행 및 확인

실행

```bash
node app/index.js
```

확인

* 정상 API: `/api/news`
* 404 테스트: `/api/unknown`
* 에러 테스트: news.json 파일명 변경


---

## 핵심 요약

* 미들웨어는 요청과 응답 사이에서 실행되는 공통 처리 로직이다
* 모든 API 응답은 ok / fail 함수로 통일한다
* 컨트롤러 에러는 `next(err)`로 넘긴다
* 404와 에러 처리 미들웨어는 항상 맨 아래에 둔다

# Express API 서버 Rate Limit 미들웨어

## 학습 목표

* Rate Limit의 개념과 목적을 설명할 수 있다
* 왜 API 서버에 요청 제한이 필요한지 이해한다
* HTTP 429 상태 코드를 설명할 수 있다
* Express에서 Rate Limit 미들웨어를 적용할 수 있다
* 전체 적용과 특정 라우트 적용의 차이를 이해한다

---

## 1. Rate Limit이란 무엇인가

Rate Limit(요청 제한)은
**같은 클라이언트가 일정 시간 동안 보낼 수 있는 요청 횟수를 제한하는 보안 미들웨어**이다.

즉,

* 서버 과부하 방지
* 무차별 요청(Brute Force) 차단
* API 남용 방지

를 목적으로 사용한다.

---

## 2. 왜 Rate Limit이 필요한가

Rate Limit이 없는 서버는 다음과 같은 문제가 생길 수 있다.

* 특정 사용자가 짧은 시간에 수백~수천 번 요청
* 로그인 API, 인증 API에 집중 공격
* 서버 CPU / 메모리 / DB 부하 증가
* 정상 사용자까지 서비스 이용 불가

Rate Limit은 이러한 상황에서
**요청 자체를 초기에 차단**하는 역할을 한다.

---

## 3. Rate Limit의 판단 기준

Rate Limit은 보통 다음 요소를 기준으로 동작한다.

* IP 주소
* 시간 범위 (예: 10초, 1분, 1시간)
* 허용 요청 횟수
* 적용 대상 라우트

예시

* 같은 IP에서
* 1분 동안
* 최대 5번 요청 허용

---

## 4. HTTP 상태 코드 429

Rate Limit에 걸리면 서버는 다음 상태 코드를 응답한다.

```
429 Too Many Requests
```

의미

> 요청을 너무 많이 보냈으므로 잠시 후 다시 시도하라

이 코드는

* 클라이언트의 요청이 잘못된 것은 아니지만
* 서버가 일시적으로 거부한다는 의미다

---

## 5. Express에서 Rate Limit 미들웨어 사용

### 5-1. 패키지 설치

```bash
npm install express-rate-limit
```

---

### 5-2. 기본 Rate Limit 미들웨어 생성

```js
const rateLimit = require("express-rate-limit");
const { fail } = require("./utils/response");

app.set("trust proxy", 1); // 요청 앞단에 프록시가 1개 있다고 가정하고, 그 프록시가 붙인 IP 관련 헤더를 신뢰하겠다

const apiLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 60,
  handler: (req, res) => {
    return fail(res, "요청이 너무 많습니다", 429);
  }
});
```

설명

* windowMs: 요청을 계산하는 시간 범위
* max: 허용 요청 횟수
* message: 제한 초과 시 응답 내용

---

## 6. Rate Limit 적용 위치

### 6-1. 전체 API에 적용

```js
app.use("/api", apiLimiter);
```

의미

* /api로 시작하는 모든 요청에 Rate Limit 적용
* 간단하지만 과도하게 제한될 수 있음

---

### 6-2. 특정 라우트에만 적용 (권장)

```js
router.post("/login", apiLimiter, loginController);
```

의미

* 로그인, 인증, 문자 발송 API 등에만 적용
* 실제 서비스에서 가장 많이 사용하는 방식

---

## 핵심 요약

* Rate Limit은 요청 횟수를 제한하는 보안 미들웨어다
* HTTP 429 상태 코드를 사용한다
* 로그인, 인증 API에 특히 중요하다
* 전체 적용보다 특정 라우트 적용이 실무에 적합하다
* 서버를 보호하는 마지막 방어선 역할을 한다

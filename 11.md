# Express API 서버 보안 미들웨어

## cors + helmet

## 학습 목표

* CORS가 왜 필요한지
* CORS 에러가 서버 문제가 아닌 이유
* helmet이 무엇을 보호하는지
* cors와 helmet의 역할 차이
* 보안 미들웨어를 app.js 어디에 두어야 하는지
* 개발 단계에서 helmet 옵션을 왜 조정하는지

---

## 1. CORS란 무엇인가

CORS(Cross-Origin Resource Sharing)는
**브라우저가 요청을 허용할지 말지를 판단하는 규칙**이다.

중요한 사실 두 가지

* CORS는 서버 오류가 아니다
* CORS는 브라우저 보안 정책이다

즉,

> 서버는 정상적으로 응답했는데
> 브라우저가 응답을 버리는 상황이 발생한다

---

## 2. 출처(Origin)의 개념

출처는 다음 3가지 조합으로 결정된다.

* 프로토콜 (http / https)
* 도메인 (localhost, example.com)
* 포트 (3000, 5173)

하나라도 다르면 **다른 출처**다.

예시

* [http://localhost:3000](http://localhost:3000)
* [http://localhost:5173](http://localhost:5173)

→ 포트가 다르므로 **다른 출처**

### 브라우저에서 fetch요청 ( cors 테스트 )
```
fetch("http://localhost:3000/api/news?limit=5&keyword=it")
  .then(res => res.json())
  .then(data => console.log(data));
```

---

## 3. API 서버에서 CORS가 필요한 이유

개발 환경 구조

* 프론트엔드(Vue): [http://localhost:5173](http://localhost:5173)
* API 서버(Express): [http://localhost:3000](http://localhost:3000)

이 경우 브라우저는 기본적으로 요청을 차단한다.

그래서 발생하는 현상

> 서버는 응답했는데
> 브라우저 콘솔에서만 에러가 난다

이때 서버가 해야 할 일은 하나다.

> 이 출처의 요청은 허용한다

라는 **응답 헤더를 보내는 것**

브라우저는 그 헤더를 보고
요청을 허용할지 말지를 결정한다.

---

## 4. cors 미들웨어 적용

### 설치

```bash
npm install cors
```

### 기본 적용

```js
const cors = require("cors");
app.use(cors());
```

이 설정의 의미

* 모든 출처 허용
* 모든 메서드 허용
* 모든 헤더 허용

→ 개발 초기 단계에서는 충분

---

## 5. cors 옵션 설정 (개발 기준)

### 출처 제한

```js
app.use(cors({
  origin: "http://localhost:5173"
}));
```

의미

* Vue 개발 서버만 허용
* 나머지는 브라우저에서 차단

---

### credentials (쿠키 / 인증 정보)

```js
app.use(cors({
  origin: "http://localhost:5173",
  credentials: true
}));
```

의미

* 쿠키, 세션, 인증 정보 전달 허용

### 중요한 규칙 ( 동시 사용 불가 )

* credentials: true 일 때
* origin: "*" 사용 불가

---

### 프론트엔드 설정도 필요

```js
fetch("http://localhost:3000/api/news?limit=5&keyword=it",{
  credentials: "include"
})
  .then(res => res.json())
  .then(data => console.log(data));
```

서버 + 클라이언트
**둘 다 설정해야 동작**

---

## 7. helmet이란 무엇인가

> helmet은
**보안 관련 HTTP 응답 헤더를 자동으로 설정해주는 미들웨어**다.

### helmet이 막아주는 대표적인 것들

* 다른 사이트에서 iframe으로 페이지 감싸기 방지
* 브라우저의 콘텐츠 타입 추측 방지
* 과도한 referrer 정보 노출 제한
* 위험한 스크립트 실행 환경 축소

중요한 관점

* helmet은 공격을 직접 막지 않는다
* 공격이 성공할 수 있는 환경을 줄인다

---

## 9. helmet 기본 적용

### 설치

```bash
npm install helmet
```

### 적용

```js
const helmet = require("helmet");
app.use(helmet());
```

---

## 10. 개발 단계에서 조정해야 할 helmet 옵션

helmet 기본값은 운영 기준이다.
개발 환경에서는 일부 옵션이 과도하게 동작한다.

```js
app.use(
  helmet({
    contentSecurityPolicy: false,
    crossOriginEmbedderPolicy: false,
    crossOriginResourcePolicy: false
  })
);
```

프론트엔드 개발 서버, HMR, 외부 리소스 충돌 방지 목적이다.

---

### 개발 / 운영 환경 분기 (권장)

```js
if (process.env.NODE_ENV === "development") {
  app.use(
    helmet({
      contentSecurityPolicy: false,
      crossOriginEmbedderPolicy: false,
      crossOriginResourcePolicy: false
    })
  );
} else {
  app.use(helmet());
}
```

---

## 11. cors와 helmet의 역할 차이

* cors
  → 누가 요청할 수 있는가

* helmet
  → 브라우저가 무엇을 할 수 있는가

비유

* cors = 출입 통제
* helmet = 행동 규칙

---

## 12. app.js에서의 적용 위치

```js
app.use(helmet());
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(requestLogger);
```

보안 정책은 항상 가장 먼저 적용한다.

---

## 핵심 요약

* CORS는 서버 에러가 아니라 브라우저 정책
* 서버는 허용 여부를 헤더로 알려줄 뿐
* helmet은 인증이 아니라 브라우저 동작 제한
* cors = 요청 출처 제어
* helmet = 응답 해석 방식 제어
* 둘 다 공통 미들웨어
* app.js 최상단에 위치

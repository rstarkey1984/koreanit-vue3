# Express API 서버 라우팅 구조화


## 학습 목표

* `app.js`와 `index.js`의 역할을 구분한다
* Router와 Controller를 파일로 분리할 수 있다

---

## 1. 서버 라우팅 코드가 많아지면  생기는 문제

```js
app.get("/api/news", function(req,res){
  ...
});
app.get("/api/users", function(req,res){
  ...
});
app.post("/api/users", function(req,res){
  ...
});
app.put("/api/users", function(req,res){
  ...
});
app.delete("/api/users", function(req,res){
  ...
});
app.get("/api/posts", function(req,res){
  ...
});
app.post("/api/posts", function(req,res){
  ...
});
app.put("/api/posts", function(req,res){
  ...
});
app.delete("/api/posts", function(req,res){
  ...
});
```

### 문제점

* API가 늘어날수록 한 파일이 비대해진다
* 기능별로 코드를 찾기 어렵다
* 팀 작업 시 충돌이 잦아진다

> 그래서 서버 라우팅을 구조화 해아한다.
---

## 2. Express에서 API 서버를 만들 때 사용하는 표준적인 라우팅 구조화 방식

```text
app/
├─ index.js
├─ app.js 
├─ routes/news.router.js
└─ controllers/news.controller.js
```
구조화 기준은 단순하다.

- index.js: “서버 실행”만 담당 (listen)

- app.js: “Express 앱 구성”만 담당 (미들웨어 + 라우터 등록)

- news.router.js: URL/메서드만 정의하고 컨트롤러 연결

- news.controller.js: 실제 처리 로직(읽기/가공/응답)

즉 역할을 분리해서, 파일을 보면 바로 성격이 보이게 만든다.

폴더 및 파일생성 명령어:
```
mkdir -p app/routes app/controllers && touch app/app.js app/index.js app/routes/news.router.js app/controllers/news.controller.js
```

---

## 3. app.js / index.js 분리

### app.js (구성 담당)

기존 코드에서 `listen`만 제거하고 `module.exports = app`을 추가한다.

```js
const express = require("express");
const fs = require("fs").promises;
const path = require("path");

const DATA_PATH = path.join(__dirname, "data", "news.json");

const app = express();

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

app.get("/", (req, res) => {
  res.send("API 서버 실행 중");
});

app.get("/api/news", async (req, res) => {
  const raw = await fs.readFile(DATA_PATH, "utf-8");
  const data = JSON.parse(raw);
  res.json(data);
});

app
  .route("/api/dev/:path")
  .get((req, res) => res.json(makeRequestInfo(req)))
  .post((req, res) => res.json(makeRequestInfo(req)))
  .put((req, res) => res.json(makeRequestInfo(req)))
  .delete((req, res) => res.json(makeRequestInfo(req)));

function makeRequestInfo(req) {
  return {
    method: req.method,
    url: req.originalUrl,
    params: req.params,
    query: req.query,
    body: req.body,
  };
}

module.exports = app;
```

---

### index.js (실행 담당)

```js
const app = require("./app");

const PORT = 3000;

app.listen(PORT, () => {
  console.log(`API 서버 실행: http://localhost:${PORT}`);
});
```

* 실행만 담당한다
* 서버 실행 방식이 바뀌면 보통 이 파일만 바꾸면 된다

---

### 실행

```bash
node app/index.js
```

기존과 동일하게 동작해야 한다.

---

## 5. Router와 Controller

### 역할 분리

* Router: URL과 메서드를 분기하고, 어떤 컨트롤러를 실행할지 연결한다
* Controller: 실제 처리(데이터 읽기, 가공, 응답)를 담당한다

### 분리하면 다음이 쉬워진다.

* Router 파일은 주소(엔드포인트) 목록처럼 보인다
* Controller 파일은 작업(함수) 목록처럼 보인다

---

## 6. Controller 만들기

컨트롤러는 요청 하나를 처리하는 함수다.
아직 URL이나 라우팅 구조를 몰라도 만들 수 있다.

`app/controllers/news.controller.js`

```js
const fs = require("fs").promises;
const path = require("path");

const DATA_PATH = path.join(__dirname, "..", "..", "data", "news.json");

async function newsListController(req, res) {
  const raw = await fs.readFile(DATA_PATH, "utf-8");
  const data = JSON.parse(raw);
  res.json(data);
}

function newsPostController(req, res) {
  return res.json({"message":"NEWS POST"});
}

function newsPutController(req, res) {
  return res.json({"message":"NEWS PUT"});
}

function newsDeleteController(req, res) {
  return res.json({"message":"NEWS DELETE"});
}

module.exports = {
  newsListController,
  newsPostController,
  newsPutController,
  newsDeleteController,
};
```
---

## 7. 컨트롤러 단독 실행

**Express 서버를 실행하지 않고**
컨트롤러 함수가 실제로 어떤 일을 하는지 **직접 실행해보는 단계**다.

이를 통해 다음을 확인한다.

* 컨트롤러는 **일반 함수**다
* Express는 단지 `req`, `res`를 만들어 컨트롤러에 전달해 줄 뿐이다
* 라우터는 “이 함수를 언제 실행할지”만 결정한다

---

### 테스트 파일 생성

```text
mkdir -p app/tests && touch app/tests/run.js
```

---

### 컨트롤러 단독 실행 코드

```js
const newsCtl = require("../controllers/news.controller");

// Express 없이 컨트롤러 직접 실행
newsCtl.newsListController({}, { json: console.log }).catch(console.error);
```

---

### 실행

```bash
node app/tests/run.js
```

---

### 실행 결과 확인

콘솔에 다음 형태의 출력이 나오면 정상이다.

```js
{
  success: true,
  message: "뉴스 목록",
  data: {...}
}
```

이 출력은 **실제 API 응답과 동일한 데이터**다.

---

### 실습 정리

* 컨트롤러는 **req, res를 받는 일반 함수**다
* `res.json()`만 있으면 Express 없이도 실행할 수 있다
* Express Router는
  이 컨트롤러를 **HTTP 요청과 연결해 주는 역할**을 한다

> 즉,
> **HTTP 요청 → Router → Controller**
> 이 흐름에서 컨트롤러는 가장 안쪽의 “실제 처리 로직”이다.

---

## 8. Router 만들기 (news만 구조화)

이번 실습에서는 `/api/news`만 **Router → Controller**로 분리한다.

* `/api/news` : 구조화 대상 (Router/Controller 분리)
* `/api/dev/:path` : 학습/테스트용이므로 **구조화하지 않고 app.js에 그대로 유지**

---

### news.router.js 생성 (URL/메서드 정의)

`app/routes/news.router.js`

```js
const express = require("express");
const router = express.Router();

const newsCtl = require("../controllers/news.controller");

// /api/news
router
  .route("/")
  .get(newsCtl.newsListController)
  .post(newsCtl.newsPostController)
  .put(newsCtl.newsPutController)
  .delete(newsCtl.newsDeleteController);

module.exports = router;
```

* Router는 **URL과 HTTP 메서드만 정의**한다
* 실제 처리 로직은 컨트롤러로 넘긴다

---

## 9. app.js에서 news Router 등록 (dev는 그대로 유지)

`app/app.js`

```js
const express = require("express");
const app = express();

const newsRouter = require("./routes/news.router");

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 서버 상태 확인
app.get("/", (req, res) => {
  res.send("API 서버 실행 중");
});

// news만 구조화해서 등록
app.use("/api/news", newsRouter);

// dev는 구조화하지 않고 그대로 둔다 (학습/테스트용)
app
  .route("/api/dev/:path")
  .get((req, res) => res.json(makeRequestInfo(req)))
  .post((req, res) => res.json(makeRequestInfo(req)))
  .put((req, res) => res.json(makeRequestInfo(req)))
  .delete((req, res) => res.json(makeRequestInfo(req)));

function makeRequestInfo(req) {
  return {
    method: req.method,
    url: req.originalUrl,
    params: req.params,
    query: req.query,
    body: req.body,
  };
}

module.exports = app;
```

* `app.use("/api/news", newsRouter)`로 prefix를 붙인다
* `/api/dev/:path`는 요청 확인용이므로 app.js에 직접 둔다

---

## 10. index.js는 서버 실행(listen)만 담당

`app/index.js`

```js
const app = require("./app");

const PORT = 3000;

app.listen(PORT, () => {
  console.log(`API 서버 실행: http://localhost:${PORT}`);
});
```

* 실행 방식이 바뀌어도 보통 index.js만 수정하면 된다

---

## 11. 폴더 구조 정리

```text
app/
├─ app.js # Express 앱 설정과 미들웨어, 라우터를 등록하는 파일
├─ index.js # app을 실행(app.listen)하는 서버 시작 파일
├─ routes/
│  └─ news.router.js # 뉴스 관련 URL과 HTTP 메서드를 정의하는 라우터
│
└─ controllers/
   └─ news.controller.js # 뉴스 데이터 처리와 응답 로직을 담당하는 컨트롤러
```

---

## 12. 실행 및 확인

### 실행

```bash
node app/index.js
```

### 확인 요청

* `GET /` : 서버 상태 확인
* `GET /api/news` : 파일(news.json) 읽어 응답
* `POST /api/news` : body 확인
* `PUT /api/news` : body 확인
* `DELETE /api/news` : 요청 확인
* `GET /api/dev/test?x=1` : params/query/body 위치 확인

---

## 핵심 요약

- 라우팅 코드가 많아지면 한 파일이 비대해진다.

- 해결책은 역할별 분리다.

- index.js 실행 / app.js 구성 / router 주소 / controller 처리

- 흐름: 요청 → app → router → controller → 응답